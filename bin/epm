#!/usr/bin/env bash
set -euo pipefail

SSH_HOST="media"

usage() {
  cat <<USAGE
Usage: epm input_file=VIDEO [output_dir=DIR] [options]

Extract photos from a video file on the media VM.

Arguments:
  input_file=PATH    Path to the video file on the media VM
  output_dir=PATH    Directory on the media VM to copy extracted photos into
                     (default: /mnt/nfs/photos/reference)

Options:
  step_time=SECONDS        Time between sampled frames (default: 0.5)
  ssim_threshold=FLOAT     SSIM similarity threshold (default: 0.90)
  border_px=INT            Border size in pixels around extracted photos (default: 5)
  update_immich=BOOL       Run Immich integration after extraction (default: true)
  help                     Show this help message

Environment variables (set on the media VM):
  IMMICH_API_KEY         Immich API key (required for Immich integration)
  IMMICH_LIBRARY_ID      Immich external library ID to scan
  IMMICH_API_URL         Immich server URL (e.g. http://localhost:2283)
  IMMICH_SHARE_USER      Immich username to share albums with (optional)

Prerequisites:
  ssh media must be configured and working.
  The repo and dependencies are auto-installed on first run.

Examples:
  epm input_file=/data/videos/sunset.mp4
  epm input_file=/data/videos/sunset.mp4 output_dir=/data/photos
  epm input_file=/data/videos/sunset.mp4 output_dir=/data/photos step_time=1.0 ssim_threshold=0.95
USAGE
}

# --- Parse arguments ---
VIDEO=""
OUTPUT="/mnt/nfs/photos/reference"
UPDATE_IMMICH="true"
EXTRA_ARGS=()

for arg in "$@"; do
  case "$arg" in
  help)
    usage
    exit 0
    ;;
  input_file=*)
    VIDEO="${arg#input_file=}"
    ;;
  output_dir=*)
    OUTPUT="${arg#output_dir=}"
    ;;
  step_time=*)
    EXTRA_ARGS+=("-s" "${arg#step_time=}")
    ;;
  ssim_threshold=*)
    EXTRA_ARGS+=("-t" "${arg#ssim_threshold=}")
    ;;
  border_px=*)
    EXTRA_ARGS+=("-b" "${arg#border_px=}")
    ;;
  update_immich=*)
    UPDATE_IMMICH="${arg#update_immich=}"
    ;;
  *)
    echo "Error: unknown argument '$arg'" >&2
    usage >&2
    exit 1
    ;;
  esac
done

if [[ -z "$VIDEO" ]]; then
  echo "Error: input_file is required." >&2
  echo >&2
  usage >&2
  exit 1
fi

# --- Auto-setup on remote ---
echo "Checking remote setup..."
ssh "$SSH_HOST" bash -l <<'SETUP'
set -euo pipefail
REPO_DIR="$HOME/extract-photos"
REPO_URL="https://github.com/johnmathews/extract-photos-from-videos.git"

if [ ! -d "$REPO_DIR" ]; then
    echo "Setting up extract-photos on remote..."

    # Check prerequisites
    if ! command -v git &>/dev/null; then
        echo "Error: git is not installed on the remote machine." >&2
        exit 1
    fi

    # Install uv if not present
    if ! command -v uv &>/dev/null; then
        echo "Installing uv..."
        curl -LsSf https://astral.sh/uv/install.sh | sh
    fi

    echo "Cloning repository..."
    git clone "$REPO_URL" "$REPO_DIR"

    echo "Installing dependencies..."
    cd "$REPO_DIR"
    uv sync

    echo "Remote setup complete."
else
    echo "Updating remote repo..."
    cd "$REPO_DIR"
    git pull --ff-only
    uv sync --quiet
fi
SETUP

# --- Run extraction ---
echo "Extracting photos from: $VIDEO"
echo "Output directory: $OUTPUT"

# Upload the extraction script to a temp file on the remote, then execute it
# with -tt. This avoids the PTY-vs-heredoc conflict where -tt causes the
# heredoc to be interpreted interactively and child processes consume stdin.
REMOTE_SCRIPT="/tmp/epm-$$.sh"

ssh "$SSH_HOST" "cat > $REMOTE_SCRIPT" <<'EXTRACTION'
set -euo pipefail

VIDEO="$1"
OUTPUT="$2"
UPDATE_IMMICH="$3"
shift 3

# Remaining args are extra flags for main.py
EXTRA=("$@")

REPO_DIR="$HOME/extract-photos"

# Validate inputs
if [ ! -f "$VIDEO" ]; then
    echo "Error: video file not found: $VIDEO" >&2
    exit 1
fi

# Create temp directory with cleanup trap
TMPDIR="$(mktemp -d)"
trap 'rm -rf "$TMPDIR"' EXIT

# Symlink the video into the temp directory
ln -s "$(realpath "$VIDEO")" "$TMPDIR/"

# Run the extraction tool
cd "$REPO_DIR"
source .venv/bin/activate
PYTHONUNBUFFERED=1 python extract_photos/main.py "$TMPDIR" "${EXTRA[@]+"${EXTRA[@]}"}"

# Find the video-specific output subdirectory (name is lowercased/sanitised by the tool)
EXTRACTED_BASE="$TMPDIR/extracted_photos"
EXTRACTED_DIR="$(find "$EXTRACTED_BASE" -mindepth 1 -maxdepth 1 -type d | head -1)"

if [ -z "$EXTRACTED_DIR" ] || [ ! -d "$EXTRACTED_DIR" ]; then
    echo "No photos extracted."
    exit 0
fi

PHOTO_COUNT="$(find "$EXTRACTED_DIR" -maxdepth 1 -type f | wc -l | tr -d ' ')"
if [ "$PHOTO_COUNT" -eq 0 ]; then
    echo "No photos extracted."
    exit 0
fi

# Copy extracted photos (files only, skip logs/ subdirectory) to a
# subdirectory of OUTPUT named after the video.
VIDEO_SUBDIR="$(basename "$EXTRACTED_DIR")"
FINAL_OUTPUT="$OUTPUT/$VIDEO_SUBDIR"
mkdir -p "$FINAL_OUTPUT"
find "$EXTRACTED_DIR" -maxdepth 1 -type f -exec cp {} "$FINAL_OUTPUT/" \;
echo "Copied $PHOTO_COUNT photo(s) to $FINAL_OUTPUT"

# Copy the original video file alongside the photos
cp "$(realpath "$VIDEO")" "$FINAL_OUTPUT/"
echo "Copied video to $FINAL_OUTPUT/$(basename "$VIDEO")"

# Immich integration: scan library, create album, add assets, share
if [ "$OUTPUT" != "/mnt/nfs/photos/reference" ]; then
    echo "Skipping Immich integration (output is not /mnt/nfs/photos/reference)"
elif [ "$UPDATE_IMMICH" != "true" ]; then
    echo "Skipping Immich integration (update_immich=false)"
else
    MISSING_VARS=()
    [ -z "${IMMICH_API_KEY:-}" ] && MISSING_VARS+=(IMMICH_API_KEY)
    [ -z "${IMMICH_LIBRARY_ID:-}" ] && MISSING_VARS+=(IMMICH_LIBRARY_ID)
    [ -z "${IMMICH_API_URL:-}" ] && MISSING_VARS+=(IMMICH_API_URL)

    if [ ${#MISSING_VARS[@]} -gt 0 ]; then
        echo "Skipping Immich integration (missing env vars: ${MISSING_VARS[*]})"
    else
        IMMICH_ARGS=(
            --api-url "$IMMICH_API_URL"
            --api-key "$IMMICH_API_KEY"
            --library-id "$IMMICH_LIBRARY_ID"
            --asset-path "$FINAL_OUTPUT"
            --video-filename "$(basename "$VIDEO")"
        )
        [ -n "${IMMICH_SHARE_USER:-}" ] && IMMICH_ARGS+=(--share-user "$IMMICH_SHARE_USER")

        python extract_photos/immich.py "${IMMICH_ARGS[@]}"
    fi
fi
EXTRACTION

# Execute with -tt so Ctrl-C kills the remote process. The trap cleans up
# the temp script regardless of how the extraction exits.
ssh -tt "$SSH_HOST" "trap 'rm -f $REMOTE_SCRIPT' EXIT; bash -l $REMOTE_SCRIPT $(printf '%q ' "$VIDEO" "$OUTPUT" "$UPDATE_IMMICH" "${EXTRA_ARGS[@]+"${EXTRA_ARGS[@]}"}")"

echo "Done."
